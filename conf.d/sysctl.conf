net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq_pie

# --- Core Network Settings ---

net.core.dev_weight = 256
# 接收（Rx）数据包
net.core.dev_weight_rx_bias = 2.25
# 发送（Tx）数据包
net.core.dev_weight_tx_bias = 1.55

# 控制 XFRM 获取请求 过期时间
net.core.xfrm_acq_expires = 3600

#net.core.xfrm_aevent_etime = 10
#net.core.xfrm_aevent_rseqth = 2
#net.core.xfrm_larval_drop = 1

# 全局套接字默认接受缓冲区
net.core.rmem_default = 262144
net.core.rmem_max = 134217728

# 全局套接字默认发送缓冲区
net.core.wmem_default = 16384
net.core.wmem_max = 134217728

# 控制单个套接字（socket）
net.core.optmem_max = 524288

# 所有网卡每次软中断最多处理的总帧数量
net.core.netdev_budget = 4096
net.core.netdev_budget_usecs = 20000

# 网卡接收队列大小（所有协议数据包）
net.core.netdev_max_backlog = 250000

# 全连接队列大小（Accept 队列）
net.core.netdev_max_backlog = 250000

net.core.somaxconn = 1024000

net.core.message_burst = 20
net.core.message_cost = 2


# --- TCP/IP Performance --

net.ipv4.ip_forward = 1
net.ipv4.tcp_timestamps = 1

net.ipv4.tcp_recovery = 3

net.ipv4.tcp_mem = 1572864 8388608 16777216
net.ipv4.udp_mem = 2097152 8388608 16777216

# 缓冲区相关配置均和内存相关
net.ipv4.tcp_rmem = 8192 262144 536870912
net.ipv4.tcp_wmem = 4096 16384 536870912
net.ipv4.ip_local_port_range = 1024 65535
net.ipv4.tcp_adv_win_scale = -2

# 强制要求 TCP 发送的最小段大小
net.ipv4.tcp_min_snd_mss = 500
net.ipv4.tcp_min_tso_segs = 2

net.ipv4.ping_group_range = 0 0

# 控制 路径拥塞状态 触发 PLB 路径切换
net.ipv4.tcp_plb_cong_thresh = 0
# 控制 TCP PLB 机制的全局启用
net.ipv4.tcp_plb_enabled = 0
# 原路径暂停重传（RTO）”的时间
net.ipv4.tcp_plb_suspend_rto_sec = 0

# 接收窗口的智能收缩机制
net.ipv4.tcp_shrink_window = 1

# 设置 TCP 接收缓冲区内存合并的最大字节数阈值
net.ipv4.tcp_collapse_max_bytes = 6291456

# 设置 TCP 发送缓冲区中“未发送数据量”的低水位阈值
net.ipv4.tcp_notsent_lowat = 131072

# 允许路由本地环回网络的流量
net.ipv4.conf.default.route_localnet = 1
net.ipv4.conf.all.route_localnet = 1
net.ipv4.conf.lo.route_localnet = 1

# 启用 TCP 的早期重传机制
net.ipv4.tcp_early_retrans = 3

# 半连接队列大小（SYN 队列）
net.ipv4.tcp_max_syn_backlog = 65536

# 同时保持 TIME_WAIT 套接字的最大数量
net.ipv4.tcp_max_tw_buckets = 1440000

# 控制 TCP 连接队列溢出行为的核心参数
net.ipv4.tcp_abort_on_overflow = 0

# TCP 自动窗口 严禁关闭
net.ipv4.tcp_window_scaling = 1

# TCP 拥塞窗口 RTO 时间 严禁调整
net.ipv4.tcp_slow_start_after_idle = 0

# 复用处于 TIME_WAIT 状态的 TCP 端口
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0

# TCP 协议中重复选择性确认
net.ipv4.tcp_dsack = 1

# 启用选择应答
net.ipv4.tcp_sack = 1

# 启用转发应答
net.ipv4.tcp_fack = 1

# 开启 F-RTO
net.ipv4.tcp_frto = 2

# 传递拥塞信息的机制
net.ipv4.tcp_ecn = 0
net.ipv4.tcp_ecn_fallback = 0

# TCP SYN 连接超时重传次数
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_syn_retries = 3

# 放弃回应一个 TCP 连接
net.ipv4.tcp_retries1 = 5

# 丢弃已建立通讯 TCP 连接
net.ipv4.tcp_retries2 = 15

# TCP 连接变为孤儿连接重试
net.ipv4.tcp_orphan_retries = 0

# 控制 TCP 连接建立 超时重传策略
net.ipv4.tcp_syn_linear_timeouts = 1

# 开启 SYN 洪水攻击保护
net.ipv4.tcp_syncookies = 0

# 反向路径过滤 严格开启
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.rp_filter = 0

net.ipv4.conf.all.arp_filter = 0

# 减少处于 FIN-WAIT-2
net.ipv4.tcp_fin_timeout = 15

# 路由缓存刷新频率
net.ipv4.route.gc_timeout = 120
net.ipv4.route.gc_min_interval_ms = 2000

# 它用于控制是否忽略所有的 ICMP 请求
net.ipv4.icmp_echo_ignore_all = 1

# 系统会忽略所有 ICMP 回显请求广播包
net.ipv4.icmp_echo_ignore_broadcasts = 1

# 控制 ICMP 错误消息的源地址选择逻辑
net.ipv4.icmp_errors_use_inbound_ifaddr = 1

# 忽略所有来自广播或多播地址的 ICMP 错误响应
net.ipv4.icmp_ignore_bogus_error_responses = 1

# TCP 基础最大报文段大小 MSS
net.ipv4.tcp_base_mss = 1460

# 发现机制允许的最小 MTU 值
net.ipv4.route.min_pmtu = 1280
net.ipv4.route.mtu_expires = 100
net.ipv6.route.mtu_expires = 100
net.ipv4.route.redirect_number = 20

# 启用 MTU 动态探测网络路径
net.ipv4.tcp_mtu_probing = 1
# 设置 MTU 探测的下限值
net.ipv4.tcp_mtu_probe_floor = 1200

# 定义 TCP 握手时通告的最小 MSS 值
net.ipv4.route.min_adv_mss = 1300

# 开启并记录欺骗, 源路由和重定向包
net.ipv4.conf.default.log_martians = 0
net.ipv4.conf.all.log_martians = 0

# 是否保存其连接 metrics 数据
net.ipv4.tcp_no_metrics_save = 1

# 控制 TCP 初始拥塞窗口的大小
net.ipv4.tcp_init_cwnd = 32

# 控制 TCP 协议 Nagle 算法
net.ipv4.tcp_nodelay = 1
net.ipv4.tcp_no_delay_ack = 1

# 控制 TCP 紧急指针的解释方式
net.ipv4.tcp_stdurg = 0

# 控制是否启用 路径 MTU 发现
net.ipv4.ip_no_pmtu_disc = 0

# 用于指定UDP接收缓冲区的最小大小
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

# 处理无源路由的包
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_source_route = 0

# TCP 调优 最大闲置时间
net.ipv4.tcp_keepalive_time = 10

# 最大失败次数
net.ipv4.tcp_keepalive_probes = 3

# 缩短 TCP 发送探测包的时间间隔
net.ipv4.tcp_keepalive_intvl = 12

# TCP 孤立连接的最大数量
net.ipv4.tcp_max_orphans = 131072

# 限制 TCP 发送队列缓冲区网络层传输的最大字节数
net.ipv4.tcp_limit_output_bytes = 262144

# arp_table 的缓存限制优化
net.ipv4.neigh.default.gc_stale_time = 120

# 关闭应用层 ARP 请求
net.ipv4.neigh.default.app_solicit = 0

net.ipv4.neigh.default.gc_thresh1 = 1024
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh3 = 8192

# ARP 严格模式 严禁调整
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.lo.arp_announce = 2

# 控制 ARP 返回 MAC 严禁开启
net.ipv4.conf.default.arp_ignore = 0
net.ipv4.conf.all.arp_ignore = 0

net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.send_redirects = 0

net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_redirects = 0

net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.secure_redirects = 0

net.ipv4.conf.default.accept_local = 1
net.ipv4.conf.all.accept_local = 1
net.ipv4.conf.lo.accept_local = 1

# 禁用 XFRM 框架
net.ipv4.conf.lo.disable_xfrm = 0


# 取消注释以下内容以停止控制台上的低级消息
kernel.printk = 3 4 1 3

# 设定程序core时生成的文件名格式
kernel.core_pattern = core_%e_%p_%t

# 控制内存“脏数据”（dirty data）积累的后台内存比例
vm.dirty_background_ratio = 5

# Linux 最低保留多少空闲内存
# vm.min_free_kbytes = 65536

# 仅用10%做为系统cache
vm.swappiness = 5
vm.dirty_ratio = 40
vm.overcommit_memory = 1
vm.overcommit_ratio = 80

# fs.nr_open = 2097152
# fs.file-max = 2097152

# 监视的最大用户监视器数量
fs.inotify.max_user_watches = 524288

# 增加系统文件描述符限制
fs.inotify.max_user_instances = 524288

# kernel.pid_max = 65536

# IPv4 TCP 低延迟参数 严禁开启
net.ipv4.tcp_low_latency = 0

# 内存区域（Zone）回收策略
vm.zone_reclaim_mode = 0

# 内核响应魔术键
kernel.sysrq = 0
kernel.panic = 0
vm.panic_on_oom = 0

# 优化 CPU 设置
kernel.sched_autogroup_enabled = 0

# 禁用 NUMA balancing
kernel.numa_balancing = 0

# TCP FastOpen
net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_fastopen_blackhole_timeout_sec = 0

# TCP 流中重排序的数据报最大数量
# net.ipv4.tcp_reordering = 10

# TCP 最大数据包重排乱序重组数量
# net.ipv4.tcp_max_reordering = 300

# 控制 TCP 协议在重传数据时的行为。
net.ipv4.tcp_retrans_collapse = 1
# net.ipv4.tcp_retrans_time_ms = 1000
# net.ipv4.tcp_challenge_ack_limit = 2000

# 自动阻塞判断
net.ipv4.tcp_autocorking = 0

net.ipv4.tcp_ack_policy = 0
net.ipv4.tcp_delack_min = 10

# TCP内存自动调整
net.ipv4.tcp_moderate_rcvbuf = 1

# 单个TSO段可消耗拥塞窗口的比例
net.ipv4.tcp_tso_win_divisor = 2

# 控制 TCP 协议在处理 TIME-WAIT 状态时的行为
net.ipv4.tcp_rfc1337 = 0

# ARP 缓存的过期时间（单位毫秒）
# net.ipv4.neigh.default.base_reachable_time_ms = 20000

# 在把记录标记为不可达之前，用多播/广播方式解析地址的最大次数
net.ipv4.neigh.default.mcast_solicit = 10
net.ipv4.neigh.all.mcast_solicit = 10

# 重发一个 ARP 请求前等待毫秒数
# net.ipv4.neigh.default.retrans_time_ms = 200
# net.ipv4.neigh.all.retrans_time_ms = 200

# 最大未处理 ARP 请求数量
net.ipv4.neigh.default.proxy_qlen = 256
net.ipv4.neigh.all.proxy_qlen = 256

# TCP 快速重传与重复确认
net.ipv4.tcp_thin_dupack = 1

# 低频活动 TCP 连接 重传超时
net.ipv4.tcp_thin_linear_timeouts = 0

# TCP Pacing Rate 调整参数（BBR 专用）
net.ipv4.tcp_pacing_ca_ratio = 0
net.ipv4.tcp_pacing_ss_ratio = 0

# 作用：内核的随机地址保护模式
kernel.randomize_va_space = 0

# Linux 内核中用于控制系统信号量
kernel.sem = 2048 1024000 2048 4096

# 虚拟化优化（KVM 环境）
kernel.sched_min_granularity_ns = 300000
kernel.sched_wakeup_granularity_ns = 500000

# vm.dirty_background_bytes = 4194304
# vm.dirty_bytes = 4194304
# vm.dirty_writeback_centisecs = 1000
# vm.dirty_expire_centisecs = 2000

vm.laptop_mode = 0

# 安全设置
kernel.kptr_restrict = 2
kernel.perf_event_paranoid = 3
kernel.yama.ptrace_scope = 1
vm.mmap_min_addr = 0

# 内核回收系统缓存回收的紧迫性
# vm.vfs_cache_pressure = 300

net.mptcp.allow_join_initial_addr_port = 0

# kernel.sched_cfs_bandwidth_slice_us = 5000
# kernel.sched_child_runs_first = 0
kernel.sched_latency_ns = 3000000
kernel.sched_migration_cost_ns = 5000000
# kernel.sched_nr_migrate = 64
# kernel.sched_rr_timeslice_ms = 100
# kernel.sched_rt_period_us = 1000000
# kernel.sched_rt_runtime_us = 500000

kernel.sched_schedstats = 0
kernel.sched_priority_sort = 0
kernel.sched_tunable_scaling = 1
kernel.sched_mc_power_savings = 0
kernel.sched_smt_power_savings = 0

# 僵任务超时时间
kernel.hung_task_timeout_secs = 1
# 僵任务警告次数
kernel.hung_task_warnings = -1
# 核心转储管道限制
kernel.core_pipe_limit = 16
# 核心文件带 PID
kernel.core_uses_pid = 1


# vm.max_map_count = 262144
# vm.nr_hugepages = 65536

# Unix 域套接字数据报队列最大长度
net.unix.max_dgram_qlen = 1024

net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_redirects = 0


# 系统所有网络接口正常启用 IPv6 协议
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0

# 自动生成和管理流标签（Flow Label）
net.ipv6.auto_flowlabels = 1
# 同时接收 IPv4 数据包 双栈兼容
net.ipv6.bindv6only = 0

net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.default.forwarding = 1

net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.default.accept_ra = 0
net.ipv6.conf.all.accept_ra = 0

net.ipv6.conf.default.autoconf = 0
net.ipv6.conf.all.autoconf = 0

# arp_table 的缓存限制优化
net.ipv6.neigh.default.gc_stale_time = 120

net.ipv6.neigh.default.gc_thresh1 = 1024
net.ipv6.neigh.default.gc_thresh2 = 4096
net.ipv6.neigh.default.gc_thresh3 = 8192


#--- netfilter ---
# 4194304 6250000 16777216 25000000
net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
# net.netfilter.nf_conntrack_buckets = 0
# net.netfilter.nf_conntrack_hashsize = 0

net.netfilter.nf_conntrack_tcp_loose = 1
net.netfilter.nf_conntrack_tcp_be_liberal = 1
net.netfilter.nf_conntrack_tcp_max_retrans = 3

net.netfilter.nf_conntrack_tcp_timeout_fin_wait =  30
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
