net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq_pie

net.ipv4.tcp_rmem = 8192 262144 536870912
net.core.rmem_default = 262144
net.core.rmem_max = 134217728

net.ipv4.tcp_wmem = 4096 16384 536870912
net.core.wmem_default = 16384
net.core.wmem_max = 134217728

net.ipv4.tcp_adv_win_scale = -2

net.ipv4.ping_group_range = 0 0

# 接收窗口的智能收缩机制
net.ipv4.tcp_shrink_window = 1

# 接收缓冲区内存合并的最大字节数阈值
net.ipv4.tcp_collapse_max_bytes = 6291456

# 发送缓冲区“未发送数据低水位阈值”
net.ipv4.tcp_notsent_lowat = 131072

# 半连接队列大小（SYN 队列）
net.ipv4.tcp_max_syn_backlog = 65536

# 同时保持 TIME_WAIT 套接字的最大数量
net.ipv4.tcp_max_tw_buckets = 8192

# 控制 TCP 连接队列溢出行为的核心参数
net.ipv4.tcp_abort_on_overflow = 0

# TCP 自动窗口 严禁关闭
net.ipv4.tcp_window_scaling = 1

# TCP 拥塞窗口 RTO 时间 严禁调整
net.ipv4.tcp_slow_start_after_idle = 0

# 复用处于 TIME_WAIT 状态的 TCP 端口
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0

# TCP SYN 连接超时重传次数
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2

# 放弃回应一个 TCP 连接
net.ipv4.tcp_retries1 = 5
# 丢弃已建立通讯 TCP 连接
net.ipv4.tcp_retries2 = 8

# TCP 连接变为孤儿连接重试
#net.ipv4.tcp_orphan_retries = 1

# 开启 SYN 洪水攻击保护
net.ipv4.tcp_syncookies = 0

# 减少处于 FIN-WAIT-2
net.ipv4.tcp_fin_timeout = 15

# 路由缓存刷新频率
net.ipv4.route.gc_timeout = 100

# ICMP 消息速率控制核心参数
net.ipv4.icmp_ratelimit = 500

# 是否保存其连接 metrics 数据
net.ipv4.tcp_no_metrics_save = 1

# 控制 TCP 协议 Nagle 算法
net.ipv4.tcp_nodelay = 1

# 控制 TCP 紧急指针
net.ipv4.tcp_stdurg = 1

# 用于指定UDP接收缓冲区的最小
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

# 后续探测报文的发送间隔
#net.ipv4.tcp_probe_interval = 120
# 空闲多久后启动保活探测
net.ipv4.tcp_keepalive_time = 10
# 保活探测最大次数
net.ipv4.tcp_keepalive_probes = 3
# 保活探测包发送间隔
net.ipv4.tcp_keepalive_intvl = 12

# 系统最大“孤儿 TCP 连接”数量
net.ipv4.tcp_max_orphans = 131072

# 禁用 XFRM 框架
net.ipv4.conf.lo.disable_xfrm = 0

# 监视的最大用户监视器数量
fs.inotify.max_user_watches = 8192
# 增加系统文件描述符限制
fs.inotify.max_user_instances = 8192

# IPv4 TCP 低延迟参数 严禁开启
net.ipv4.tcp_low_latency = 0

# TCP FastOpen
net.ipv4.tcp_fastopen = 3

# TCP 重传小分片合并开关
net.ipv4.tcp_retrans_collapse = 1

# 自动阻塞判断
#net.ipv4.tcp_autocorking = 0

# 延迟确认的最小延迟时间
net.ipv4.tcp_delack_min = 0
# 延迟确认的最大延迟时间
net.ipv4.tcp_delack_max = 0

# TCP内存自动调整
net.ipv4.tcp_moderate_rcvbuf = 1

# 单个TSO段可消耗拥塞窗口的比例
#net.ipv4.tcp_tso_win_divisor = 2

# 防御 TCP 状态攻击
net.ipv4.tcp_rfc1337 = 0

# TCP Pacing Rate 调整参数
net.ipv4.tcp_pacing_ca_ratio = 0
net.ipv4.tcp_pacing_ss_ratio = 0


# --- netfilter optimization ---


# --- Recovery mechanism ---

# 网络异常时恢复机制
net.ipv4.tcp_recovery = 3

# 启用 TCP 的早期重传机制
net.ipv4.tcp_early_retrans = 3

# TCP 快速重传与重复确认
net.ipv4.tcp_thin_dupack = 1

# TCP 协议中重复选择性确认
net.ipv4.tcp_dsack = 1

# 启用选择应答
net.ipv4.tcp_sack = 1

# 启用转发应答
net.ipv4.tcp_fack = 1

# 开启 F-RTO
net.ipv4.tcp_frto = 2


# --- kernel optimization ---

# 作用：内核的随机地址保护模式
kernel.randomize_va_space = 2

# Linux 内核中用于控制系统信号量
kernel.sem = 2048 262144 2048 4096

# 取消注释以下内容以停止控制台上的低级消息
kernel.printk = 3 4 1 3

# 设定程序 core 时生成的文件名格式
kernel.core_pattern = core_%e_%p_%t

# 优化 CPU 设置
kernel.sched_autogroup_enabled = 0

# 禁用 NUMA balancing
kernel.numa_balancing = 0

# 内核响应魔术键
kernel.sysrq = 0
kernel.panic = 0


# --- core optimization ---

# 每 CPU 最大处理包数上限
net.core.dev_weight = 600

# 控制单个套接字（socket）
net.core.optmem_max = 524288

# 网卡接收队列大小（所有协议数据包）
net.core.netdev_max_backlog = 250000

# 全连接队列大小（Accept 队列）
net.core.somaxconn = 1024000

net.core.message_burst = 30
net.core.message_cost = 5


# --- Cybersecurity ---


# --- Other optimizations ---

net.ipv4.ip_local_port_range = 1024 65535

net.ipv4.neigh.default.gc_thresh3 = 8192
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh1 = 2048

net.ipv6.neigh.default.gc_thresh3 = 8192
net.ipv6.neigh.default.gc_thresh2 = 4096
net.ipv6.neigh.default.gc_thresh1 = 2048

vm.swappiness = 10
vm.dirty_ratio = 20
vm.dirty_background_ratio = 5
vm.overcommit_memory = 1

# 电源管理参数
vm.laptop_mode = 0

# thing

fs.file-max = 1024000

# 默认 MSS 基础值
net.ipv4.tcp_base_mss = 1400
# 最小 MSS 值
net.ipv4.route.min_adv_mss = 536
net.ipv6.route.min_adv_mss = 1220
# 最小 MTU 探测下限
net.ipv4.tcp_mtu_probe_floor = 576
# 最小路径 MTU 值
net.ipv4.route.min_pmtu = 576
# 最小发送 MSS 值
net.ipv4.tcp_min_snd_mss = 536